<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8">
  <title>Stable Diffusion 1.5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-dark text-white vh-100 m-0 d-flex flex-column">

  <div class="container-fluid d-flex flex-column flex-grow-1 p-3">
    <!-- Textarea que cresce -->
    <div id="inputContainer" class="flex-grow-1 mb-3 d-flex flex-column">
      <textarea class="form-control flex-grow-1 mb-3" id="promptText" 
        data-i18n="proj1_placeholder"
        placeholder="Imagem que Deseja Gerar 'em Ingles'"
        maxlength="170"></textarea>
    </div>
    <div id="status" class="mt-2 text-info small"></div>
    <button id="gerarBtn" class="btn btn-info btn-sm align-self-start" 
    data-i18n="proj1_button"
    onclick="enviarPrompt()">Gerar</button>
  </div>

  <!---
  <div class="hideoniframe col-md-7 offset-md-0 col-12">
    <div id="form-center" class="border bg-white text-black p-3 rounded shadow">
      <h5 class="card-title" data-i18n="proj1_title">Gerador de Imagem SD 1.5</h5>
    <p class="card-text" data-i18n="proj1_desc">Gerador de imagem feito em Python 3.11, rodando Stable Diffusion 1.5 sem GPU, apenas com
      processador</p>
    </div>
  </div>
-->

  
  <div class="hideoniframe container-fluid d-flex flex-column flex-grow-1 col-md-8 offset-md-2 col-12">
    <div id="form-center" class="border bg-white text-black p-3 rounded shadow">
    <h5 class="card-title text-danger" data-i18n="proj1_title">Gerador de Imagem SD 1.5</h5>
    <div class="card-text" data-i18n="proj1_desc">
      Gerador de imagem feito em Python 3.11, rodando Stable Diffusion 1.5 sem GPU, apenas com
      processador.<br>
      Utiliza FastSD CPU, uma versão mais rápida da Difusão Estável na CPU, baseada em Modelos de Consistência Latente e Destilação de Difusão Adversarial.
      <br><br>Codigo Original: <a href="https://github.com/rupeshs/fastsdcpu" target="_blank">https://github.com/rupeshs/fastsdcpu</a>
    </div>
    </div>
  </div>


  <script>
    (() => {
      if (location.hash === "#iframe") {
        const hide = () => document.querySelectorAll('.hideoniframe')
          .forEach(el => el.style.setProperty('display', 'none', 'important'));
        document.readyState === "loading" ? document.addEventListener("DOMContentLoaded", hide) : hide();
      }
    })();

    function enviarPrompt() {
      const prompt = document.getElementById('promptText').value.trim();
      const statusDiv = document.getElementById('status');
      const button = document.getElementById('gerarBtn');
      const inputContainer = document.getElementById('inputContainer');
      const textarea = document.getElementById('promptText');

      if (!prompt) {
        statusDiv.textContent = "Por favor, digite um prompt.";
        return;
      }

      button.disabled = true;
      textarea.disabled = true;
      statusDiv.textContent = "Requerimento na fila, aguarde...";

      fetch('/gerar-imagem', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      })
        .then(res => res.json())
        .then(data => {
          button.disabled = false;

          const status = data.status || "";
          if (status.includes("#")) {
            const parts = status.split("#");
            const imagePath = parts[0];
            const tempo = parts[1] || "";

            const img = document.createElement('img');
            img.src = "./fastcpu/results/" + imagePath;
            img.className = "img-fluid rounded border";

            inputContainer.innerHTML = ""; // remove textarea
            inputContainer.appendChild(img);
            button.style.display = 'none';

            statusDiv.textContent = tempo;
          } else {
            statusDiv.textContent = status;
          }
        })
        .catch(err => {
          console.error(err);
          button.disabled = false;
          statusDiv.textContent = "Erro ao enviar prompt.";
        });
    }
  </script>
<script src="../translation.js"></script>
</body>

</html>